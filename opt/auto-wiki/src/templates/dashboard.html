<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ trans.title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; margin-bottom: 20px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-running { background-color: #ffc107; }
    </style>
</head>
<body>
    <div id="app" class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3"><i class="bi bi-robot"></i> {{ trans.title }}</h1>
            <span class="badge bg-secondary">User: {{ username }}</span>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card p-3">
                    <h6 class="text-muted">{{ trans.cpu }}</h6>
                    <h3 class="mb-0">[[ status.cpu_percent ]]%</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <h6 class="text-muted">{{ trans.memory }}</h6>
                    <h3 class="mb-0">[[ status.memory_percent ]]%</h3>
                    <small>[[ status.memory_used_gb ]]GB / [[ status.memory_total_gb ]]GB</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <h6 class="text-muted">{{ trans.disk }}</h6>
                    <h3 class="mb-0">[[ status.disk_free_gb ]]GB</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <h6 class="text-muted">{{ trans.ai_engine }}</h6>
                    <h3 class="mb-0">
                        <span class="status-indicator" :class="status.ollama_status === 'Online' ? 'status-online' : 'status-offline'"></span>
                        [[ status.ollama_status ]]
                    </h3>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{{ trans.task_queue }}</h5>
                        <button class="btn btn-sm btn-outline-primary" @click="fetchTasks"><i class="bi bi-arrow-clockwise"></i> {{ trans.refresh }}</button>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>{{ trans.col_topic }}</th>
                                    <th>{{ trans.col_priority }}</th>
                                    <th>{{ trans.col_status }}</th>
                                    <th>{{ trans.col_next }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="task in tasks" :key="task.topic">
                                    <td class="fw-bold">[[ task.topic ]]</td>
                                    <td>
                                        <span class="badge bg-info" v-if="task.priority >= 8">{{ trans.badge_high }}</span>
                                        <span class="badge bg-secondary" v-else>{{ trans.badge_norm }}</span>
                                    </td>
                                    <td>
                                        <span class="badge" 
                                            :class="{
                                                'bg-warning text-dark': task.status === 'RUNNING',
                                                'bg-success': task.status === 'FINISHED',
                                                'bg-secondary': task.status === 'PENDING'
                                            }">
                                            [[ task.status ]]
                                        </span>
                                    </td>
                                    <td>[[ task.next_run ]]</td>
                                </tr>
                                <tr v-if="tasks.length === 0">
                                    <td colspan="4" class="text-center text-muted py-3">{{ trans.no_tasks }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">{{ trans.manual_task }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">{{ trans.label_topic }}</label>
                            <input type="text" class="form-control" v-model="newTaskTopic" placeholder="{{ trans.placeholder_topic }}" @keyup.enter="addTask">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{{ trans.label_priority }}</label>
                            <select class="form-select" v-model="newTaskPriority">
                                <option value="10">{{ trans.prio_high }}</option>
                                <option value="5">{{ trans.prio_normal }}</option>
                            </select>
                        </div>
                        <button class="btn btn-primary w-100" @click="addTask" :disabled="!newTaskTopic">
                            <i class="bi bi-plus-circle"></i> {{ trans.btn_add }}
                        </button>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">{{ trans.logs }}</h5>
                    </div>
                    <div class="card-body bg-dark text-light font-monospace" style="max-height: 200px; overflow-y: auto; font-size: 0.8rem;">
                        <div v-for="log in logs">[[ log ]]</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            delimiters: ['[[', ']]'], // Jinja2との競合回避
            data: {
                status: { cpu_percent: 0, memory_percent: 0, ollama_status: 'Checking...' },
                tasks: [],
                logs: [],
                newTaskTopic: '',
                newTaskPriority: 10,
                timer: null
            },
            mounted() {
                this.fetchData();
                this.timer = setInterval(this.fetchData, 5000); // 5秒ごとに更新
            },
            methods: {
                async fetchData() {
                    try {
                        const [statusRes, tasksRes, logsRes] = await Promise.all([
                            axios.get('/api/status'),
                            axios.get('/api/tasks'),
                            axios.get('/api/logs')
                        ]);
                        this.status = statusRes.data;
                        this.tasks = tasksRes.data;
                        this.logs = logsRes.data.logs;
                    } catch (e) {
                        console.error("Connection lost", e);
                    }
                },
                async addTask() {
                    if (!this.newTaskTopic) return;
                    try {
                        await axios.post('/api/tasks', {
                            topic: this.newTaskTopic,
                            priority: parseInt(this.newTaskPriority)
                        });
                        this.newTaskTopic = '';
                        this.fetchData(); // 即座に更新
                    } catch (e) {
                        alert("Failed to add task.");
                    }
                }
            }
        });
    </script>
</body>
</html>

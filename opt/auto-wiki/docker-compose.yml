services:
  # --- Wiki Infrastructure ---
  mediawiki:
    image: mediawiki:lts
    restart: always
    ports:
      - "8080:80"
    volumes:
      - ./data/mediawiki_html:/var/www/html/
      - ./data/mediawiki_images:/var/www/html/images
    environment:
      - MW_DB_HOST=mariadb
      - MW_DB_USER=wikiuser
      - MW_DB_PASSWORD=${WIKI_DB_PASS}
      - MW_DB_NAME=my_wiki
    depends_on:
      - mariadb
    networks:
      - wiki-net

  mariadb:
    image: mariadb:10.11
    restart: always
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW --max_allowed_packet=1G
    volumes:
      - ./data/mediawiki_db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASS}
      - MYSQL_DATABASE=my_wiki
      - MYSQL_USER=wikiuser
      - MYSQL_PASSWORD=${WIKI_DB_PASS}
    networks:
      - wiki-net

  # --- AI Infrastructure ---
  ollama:
    image: ollama/ollama:latest
    restart: always
    volumes:
      - ./data/ollama:/root/.ollama
    ports:
      - "11434:11434"
    networks:
      - wiki-net

  # --- Autonomous Agents ---
  wiki-bot:
    build: 
      context: .
      dockerfile: Dockerfile
    command: python src/main.py
    volumes:
      - ./src:/app/src
      - ./data/chromadb:/app/wiki_vector_db
      - ./data/scheduler.db:/app/scheduler.db
    environment:
      - WIKI_HOST=mediawiki:80
      - BOT_USER=${BOT_USER}
      - BOT_PASS=${BOT_PASS}
      - OLLAMA_HOST=http://ollama:11434/v1
      - MODEL_NAME=${MODEL_NAME:-gemma2}
      - OPENAI_API_KEY=ollama
      - PYTHONPATH=/app
    depends_on:
      - mediawiki
      - ollama
    networks:
      - wiki-net

  rag-api:
    build: 
      context: .
      dockerfile: Dockerfile
    command: uvicorn src.api_server:app --host 0.0.0.0 --port 8000
    volumes:
      - ./src:/app/src
      - ./data/chromadb:/app/wiki_vector_db
      - ./data/scheduler.db:/app/scheduler.db
    ports:
      - "8000:8000"
    environment:
      - WIKI_HOST=mediawiki:80
      - OLLAMA_HOST=http://ollama:11434/v1
      - MODEL_NAME=${MODEL_NAME:-gemma2}
      - ADMIN_USER=${ADMIN_USER}
      - ADMIN_PASS=${ADMIN_PASS}
      - OPENAI_API_KEY=ollama
      - PYTHONPATH=/app
    networks:
      - wiki-net

networks:
  wiki-net:
    driver: bridge